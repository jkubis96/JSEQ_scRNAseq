#!/bin/bash


function container_install {


echo ''
echo -e '\033[1;32m To start the installation, Docker must be installed beforehand.'
echo -e '\033[1;32m If Docker is already installed, you can initiate the installation by using the install option,' 
echo -e '\033[1;32m which allows for installation via a Dockerfile, or by using the pull option,'
echo -e '\033[1;32m which retrieves a pre-built Docker image.'
echo ''
echo -e '\033[1;32m If you need help click ------>  \e]8;;https://docs.docker.com/engine/install/\e\\How to install docker?\e]8;;\e\\ [https://docs.docker.com/engine/install/]'

echo ''
echo -e '\033[1;36m Select option:'
echo ''
echo -e '\033[1;36m  -> Docker container installation [1]'
echo -e '\033[1;36m  -> Docker container pulling [2]'
echo -e '\033[1;36m  -> Back [b]'
echo ''
		read con
		con=$(echo $con | tr '[:upper:]' '[:lower:]')

if [[ $con == '1' ]]
then
	
	log_install=$(pwd)/install.log.out
	
	echo -e "\033[0;31m $(date) Docker build starting..."
	sudo DOCKER_BUILDKIT=1 docker build --build-arg BUILDKIT_STEP_LOG_MAX_SIZE=10485760 --no-cache -t jseq -f Dockerfile .
	id=$(docker images --format "{{.ID}}" jseq)

	length=${#id}

	length=${#id}
	
	if [[ $length -ge 4 && $length -le 20 ]]; then
    	
		echo $id
		echo id=$id > $(pwd)/docker_id
		
		docker run --privileged --rm -it \
			-v $(pwd):/app \
			-e fun_run=True \
			$id /app/scripts/docker


	else
		echo ''
		echo -e '\033[1;31m !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'
		echo ''
		echo -e '\033[1;31m The trouble with Docker'
		echo -e '\033[1;31m Check if Docker is running or even installed'
		echo -e '\033[1;31m If you have problems, read the README or don`t hesitate to contact us!'
		echo ''
		echo -e '\033[1;31m !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'
		echo ''

		starting_point

	fi
	
	
	
elif [[ $con == '2' ]]
then

    log_install=$(pwd)/install.log.out
	
	echo -e "\033[0;31m $(date) Docker pull starting..."
	sudo docker pull jkubis96/jseq_scrnaseq:latest
	id=$(docker images --format "{{.ID}}" jkubis96/jseq_scrnaseq:latest)
	
	length=${#id}
	
	if [[ $length -ge 4 && $length -le 20 ]]; then
    	
		echo $id
		echo id=$id > $(pwd)/docker_id

		docker run --privileged --rm -it \
			-v $(pwd):/app \
			-e fun_run=True \
			$id /app/scripts/docker

	else
		echo ''
		echo -e '\033[1;31m !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'
		echo ''
		echo -e '\033[1;31m The trouble with Docker'
		echo -e '\033[1;31m Check if Docker is running or even installed'
		echo -e '\033[1;31m If you have problems, read the README or don`t hesitate to contact us!'
		echo ''
		echo -e '\033[1;31m !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'
		echo ''

		starting_point

	fi
	
	
	
elif [[ $con == 'b' ]]
then

    starting_point
	
else 
		container_install
fi

}



function starting_point {

files_1=$(pwd)/requirements_file/
files_2=$(pwd)/scripts/

for file in "$files_1"/*; do
    if [[ -f "$file" && "$file" != *.xlsx ]]; then
        if grep -q $'\r' "$file"; then
            sed -i 's/\r$//' "$file"
        fi
    fi
done

for file in "$files_2"/*; do
    if [[ -f "$file" ]]; then
        if grep -q $'\r' "$file"; then
            sed -i 's/\r$//' "$file"
        fi
    fi
done



echo ''
echo -e '\033[1;33m Welcome to the JSEQ_scRNAseq© tool'
echo -e '\033[1;33m The pipeline was prepared at the Institute of Bioorganic Chemistry, Polish Academy of Sciences'
echo -e '\033[1;33m All information and references you can check README on GitHub'
echo -e '\033[1;33m Contact: jbiosystem@gmail.com or jakub.kubis1996@gmail.com'
echo ''
echo ''

echo -e '\033[1;36m Select option:'
echo ''
echo -e '\033[1;36m  -> Install [1]'
echo -e '\033[1;36m  -> Start program [2]'
echo -e '\033[1;36m  -> Exit [q]'
echo ''
	

echo ''
		read l
		l=$(echo $l | tr '[:upper:]' '[:lower:]')


if [[ $l == '1' ]]
then

container_install
		
elif [[ $l == '2' ]]
then
    
	if [[ -f $(pwd)/docker_id ]];
	then

		source $(pwd)/docker_id
		id=$id
		docker run --privileged --rm -it \
			-v $(pwd):/app \
			-e fun_run=True \
			$id /app/scripts/docker
	
	else
		
		echo ''
		echo -e '\033[1;31m !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'
		echo ''
		echo -e '\033[1;31m The JSEQ_scRNAseq© tool has not been installed'
		echo -e '\033[1;31m The tool must be installed before starting'
		echo -e '\033[1;31m Check if Docker is installed and install the JSEQ_scRNAseq© tool'
		echo -e '\033[1;31m If you have problems, read the README or don`t hesitate to contact us!'
		echo ''
		echo -e '\033[1;31m !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'
		echo ''

		starting_point

	fi
	
elif [[ $l == 'q' ]]
then

	exit

else 
		starting_point
fi

}

starting_point



