---
title: "JSEQ_scRNAseq - REPORT"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly       
    highlight: tango
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
    self_contained: true
    css: "../scripts/custom.css"


---


```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(DT)
library(kableExtra)

set.seed(123)

read_config <- function(path) {
  conf <- read.csv(path, header = FALSE, sep = ":", row.names = 1, comment.char = "#", stringsAsFactors = FALSE)
  conf_list <- setNames(as.list(conf$V2), rownames(conf))
  conf_list <- lapply(conf_list, function(x) {
    if (x %in% c("TRUE", "FALSE")) return(as.logical(x))
    if (suppressWarnings(!is.na(as.numeric(x)))) return(as.numeric(x))
    return(as.character(x))
  })
  return(conf_list)
}

print(getwd())
args <- commandArgs()

project_path <- args[6]

config <- read_config(file.path('../requirements_file/config_file.conf'))

results_dir <- file.path(project_path, "results")

chceck_fq <- grepl("_fq", results_dir)


show_image <- function(path, caption = NULL, width = NULL, height = NULL) {
  if (file.exists(path)) {
    if (!is.null(caption)) cat(sprintf("%s\n", caption))
    knitr::include_graphics(path, dpi = 300, auto_pdf = FALSE)
  } 
}

```


---

**The report was generated using the JSEQ_scRNAseqÂ© single-cell analysis pipeline.**
**For more information, please visit: [https://github.com/jkubis96/JSEQ_scRNAseq](https://github.com/jkubis96/JSEQ_scRNAseq)**

---


# Analysis Configuration Parameters

```{r echo=FALSE}
params_df <- data.frame(
  Parameter = names(config),
  Value = unlist(config)
)

params_df <- params_df[!params_df$Parameter %in% c('down', 'up'),]

params_df %>%
  kbl(caption = "", row.names = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed"))
```


---

# Cell content analysis


```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

if (chceck_fq ){

  show_image(file.path(results_dir, "scRNAmetrics.jpeg"), "## Read distribution across genomic features")
  
}

```

```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

if (chceck_fq ){
  
show_image(file.path(results_dir, "expect_whitelist_cell_barcode_counts.png"), "## Count (UMI) per barcode (cell)")
  
}

```

```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}


if (chceck_fq ){
  
show_image(file.path(results_dir, "expect_whitelist_cell_barcode_knee.png"), "## Cell barcode knee plot")
  
}

```


```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

if (chceck_fq){
  
cat('*The above graph illustrates general trends and quality metrics at the initial stage of single-cell analysis; however, it does not represent the final number of detected cells.*')

cat('<br><br>')

}
```



```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}
show_image(file.path(results_dir, "counts~genes.svg"), "## Number of genes and counts per cell")

```


```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}
show_image(file.path(results_dir, "counts~genes_QC.svg"), "## Ratio of number of genes to counts")

```


```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}
show_image(file.path(results_dir, "counts~genes.svg"), "## Number of genes and counts per cell")

```



```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}


file_path <- file.path(results_dir, "Ribo~Mito.svg")

if (file.exists(file_path)) {
  
 show_image(file.path(results_dir, "Ribo~Mito.svg"), "## Percentage of ribosomal and mitochondrial genes [%]")

}


```


---

# Quality control of cell content

```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "DropletQC_hist.svg"), "## Genes per cell content & thresholds")


```


```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "DropletQC.svg"), "## Genes upper & lower thresholds per cell")


```


```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "Cells.svg"), "## Number of cells across different stages of analysis")


```



---

# Gene expression analysis across cells


```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "variable_genes.svg"), "## Top highly variable genes in the dataset")

```


---

# Princilpe component selection


```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "Elbow.svg"), "## ElbowPlot - Principal components cutoff")

```

```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "JackStrawPlot.svg"), "## JackStrawPlot - PC significance")

```


---

# Cells clustering

```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "UMAP_clusters.svg"), "## UMAP Clusters")


```


---

# Subclasses identification based on marker genes



```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "PCA_DimPlot_subclasses.svg"), "## PCA Visualization of Subclasses")

```

```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "UMAP_DimPlot_subclasses.svg"), "## UMAP Visualization of Subclasses")

```

```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "subclasses_composition.svg"), "## Subclass Cell Composition")


```

\

## Subclasses markers - top 25

\

```{r echo=FALSE, message=FALSE, warning=FALSE, align="center", results='asis'}
markers <- read.csv(file = file.path(results_dir, 'markers_subclasses.csv'), header = T, sep = ',', row.names = 1)


markers <- markers %>%
  group_by(cluster) %>% top_n(n = 25, wt = esm)

# datatable(markers, filter = 'top')


markers %>%
  kable("html", caption = "Top 25 merkers", escape = FALSE) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    position = "center"
  ) %>%
  scroll_box(width = "100%", height = "550px")
```


---

# Subtypes identification based on CSSG genes



## UMAP visualization

\


```{r echo=FALSE, message=FALSE, warning=FALSE}

plot_meta <- read.csv(file = file.path(results_dir, 'metadata.csv'), header = T, sep = ',', row.names = 1)

plot_meta <- plot_meta[plot_meta$reduced == FALSE,]

plot_meta$names <- paste0('Subtype:\n' ,plot_meta$subtypes, '\nn: ',  plot_meta$n_subtype)
p <- plotly::plot_ly(
  data = plot_meta,
  x = ~fUMAP1,
  y = ~fUMAP2,
  color = ~subtypes,
  text = ~names,
  colors = "Set2",
  type = "scatter",
  mode = "markers",
  marker = list(size = 6, opacity = 0.9),
  hoverinfo = "text",
  hovertemplate = "%{text}<extra></extra>"
) %>%
  plotly::layout(
    xaxis = list(title = "fUMAP_1", zeroline = FALSE),
    yaxis = list(title = "fUMAP_2", zeroline = FALSE),
    legend = list(
      orientation = "v",
      x = 1.02,
      y = 0.5,
      xanchor = "left",
      yanchor = "middle",
      tracegroupgap = 3,
      itemwidth = 50,
      font = list(size = 9)
    ),
    margin = list(t = 60, b = 120, l = 60, r = 120),
    hovermode = "closest",
    autosize = TRUE
  )

p <- plotly::layout(p, height = 850, width = 1350)

p

```



```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "subtypes_composition.svg"), "## Subtype Cell Composition (CSSG)")


```

\

## Subtypes markers - top 25

\

```{r echo=FALSE, message=FALSE, warning=FALSE, align="center", }
markers <- read.csv(file = file.path(results_dir, 'markers_subtypes.csv'), header = T, sep = ',', row.names = 1)

markers <- markers %>%
  group_by(cluster) %>% top_n(n = 25, wt = esm)

markers %>%
  kable("html", caption = "Top 25 markers", escape = FALSE) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    position = "center"
  ) %>%
  scroll_box(width = "100%", height = "550px")
```

\


```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "heatmap_cells_populations.svg"), "## Heatmap of cell subtypes - log(CPM + 1)")

```



```{r echo=FALSE, out.width = '100%', fig.align="center", results='asis'}

show_image(file.path(results_dir, "heatmap_cells_populations_scaled.svg"), "## Heatmap of cell subtypes - Scaled(log(CPM + 1))")

```

\

---

# Disclaimer

The analysis was performed through the non-profit and open-source pipeline **JSEQ_scRNAseq**.
It is part of the **JBioSystem** project, which develops complex bioinformatics analysis software.
Remember, *in silico* analysis must be validated *in vitro* or *in vivo*. For more information, visit GitHub or contact us. 
**JSEQ_scRNAseq** was created at the Institute of Bioorganic Chemistry, Polish Academy of Sciences.

---

\